#!/bin/sh
#
# SLURM HEADER
#############################################
# JOB INFO

#SBATCH --time=00-18:00:00
#SBATCH --job-name=PHIST_Blanes_prok_Virus
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=24
#SBATCH --mem=25G
#SBATCH --output=/mnt/smart/users/fcoutinho/Job_Logs/%J.out
#SBATCH --error=/mnt/smart/users/fcoutinho/Job_Logs/%J.err
#SBATCH --mail-type=All
#SBATCH --mail-user=fhernandes@icm.csic.es

##############################################
#module load cesga/2020 blast/2.13.0-Linux_x86_64 miniconda3/22.11.1-1
#module load cesga/system miniconda3/22.11.1-1

#export PATH="/mnt/netapp1/Store_CSIC/home/csic/eyg/fhc/Software/PHIST:$PATH"

#Run phist manually
#cd /mnt/lustre/scratch/nlsas/home/csic/eyg/fhc/Blanes_Vir_Nestor/PHIST_Predictions/
#We use the split sequence files generated by iPhop to avoid duplicating thousands of files
#phist.py -t 6 /mnt/lustre/scratch/nlsas/home/csic/eyg/fhc/Blanes_Vir_Nestor/test_Vir/ /mnt/lustre/scratch/nlsas/home/csic/eyg/fhc/Blanes_Vir_Nestor/test_Host/ /mnt/lustre/scratch/nlsas/home/csic/eyg/fhc/Blanes_Vir_Nestor/PHIST_Output/test_run/ > test_run.log &

#phist.py -t 47 /mnt/lustre/scratch/nlsas/home/csic/eyg/fhc/Blanes_Vir_Nestor/iPHoP_Results/Wdir/split_input/ /mnt/lustre/scratch/nlsas/home/csic/eyg/fhc/Blanes_Vir_Nestor/Prok_MAGs_Sequences/ /mnt/lustre/scratch/nlsas/home/csic/eyg/fhc/Blanes_Vir_Nestor/PHIST_Predictions/PHIST_Output/
#grep "," PHIST_Output/predictions.csv > PHIST_Output/positive_predictions.csv

#Now parse otuput with Virathon
#conda activate /mnt/netapp1/Store_CSIC/home/csic/eyg/fhc/Conda_Envs/basic

#python3 /mnt/netapp1/Store_CSIC/home/csic/eyg/fhc/repos/virathon/Virathon.py --threads 47 --genome_files /mnt/lustre/scratch/nlsas/home/csic/eyg/fhc/Blanes_Vir_Nestor/Vir_MAGs_Sequences/dsDNAphage_Blanes_virus.fasta --phist_host_prediction True --putative_host_genomes_directory /mnt/lustre/scratch/nlsas/home/csic/eyg/fhc/Blanes_Vir_Nestor/Prok_MAGs_Sequences/  --extension_putative_host_genomes fasta --parse_only True

#--remove_exact_matches True


###Redo with clean MAGs
cd /mnt/smart/users/fcoutinho/Blanes_Vir_Nestor/PHIST_Predictions/PHIST_Output_Clean_MAGs

#module load python blast/2.7.1

#python3 /mnt/smart/users/fcoutinho/virathon/Virathon.py --threads 23 --phist_host_prediction True --remove_exact_matches True --genome_files /mnt/smart/users/fcoutinho/Blanes_Vir_Nestor/dsDNAphage_Blanes_virus+viruses_in_bins.fasta --putative_host_genomes_directory /mnt/smart/users/fcoutinho/Blanes_Vir_Nestor/Sequences/Prok_MAGs/Prok_MAGs_Sequences/ --extension_putative_host_genomes fasta

module load python

python3 /mnt/lustre/bio/users/fcoutinho/PHIST/phist.py -t 23 /mnt/smart/users/fcoutinho/Blanes_Vir_Nestor/PHIST_Predictions/PHIST_Output_Clean_MAGs/Viral_Genomes_PHIST/ /mnt/smart/users/fcoutinho/Blanes_Vir_Nestor/PHIST_Predictions/PHIST_Output_Clean_MAGs/No_Vir_Host_Genomes/ PHIST_Kmers.csv PHIST_Predictions.csv

grep "," PHIST_Output/predictions.csv > PHIST_Output/positive_predictions.csv